<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weather Dashboard</title>
  <meta name="viewport" content="width=800, height=480, initial-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='chart.js') }}"></script>
</head>
<body>
  <header>
    <div class="location">{{ location }}</div>
    <div class="current-date">{{ current.formatted_date }}</div>
  </header>

  <div class="main-content">
    <div class="current-weather">
      <div class="weather-icon">
        <img src="{{ url_for('static', filename='icons/' + get_weather_icon(current.weathercode)) }}" alt="Current Weather">
      </div>
      <div class="temperature">{{ current.temperature_2m }}°C</div>
    </div>

    <div class="hourly-chart">
      <h3>Voorspelling per uur</h3>
      <canvas id="hourlyChart"></canvas>
    </div>
  </div>

  <div class="daily-forecast">
    {% for day in daily.time %}
      <div class="forecast-card">
        <strong>{{ day }}</strong>
        <div class="weather-icon">
          <img src="{{ url_for('static', filename='icons/' + get_weather_icon(daily.weathercode[loop.index0])) }}" alt="Weather Icon">
        </div>
        <div class="temperature">
          <span class="temperature-max">{{ daily.temperature_2m_max[loop.index0] }}°C</span>
          <span class="temperature-min">{{ daily.temperature_2m_min[loop.index0] }}°C</span>
        </div>
      </div>
    {% endfor %}
  </div>

  <script>
    const hourlyData = {{ hourly | tojson | safe }};
    const currentHourIndex = {{ current_hour_index }};
    createHourlyChart(hourlyData, currentHourIndex);

    // Check if weather data is stale and force refresh if needed
    function checkFreshness() {
      const now = new Date();
      const lastUpdated = new Date("{{ last_updated }}");
      const hoursSinceUpdate = (now - lastUpdated) / (1000 * 60 * 60);
      
      if (hoursSinceUpdate > 1.1) {
        console.log("Weather data is stale, refreshing...");
        fetch("/refresh").then(() => window.location.reload());
      }
    }
    
    // Check freshness on page load and every 5 minutes
    checkFreshness();
    setInterval(checkFreshness, 5 * 60 * 1000);
  </script>
</body>
</html>