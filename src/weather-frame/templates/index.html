<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weather Dashboard</title>
  <meta name="viewport" content="width=800, height=480, initial-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{{ url_for('static', filename='chart.js') }}"></script>
</head>
<body>
  <header>
    <div class="location">{{ location }}</div>
    <div class="current-date">{{ current.formatted_date }}</div>
  </header>

  <div class="main-content">
    <div class="current-weather">
      <div class="weather-icon">
        <!-- TODO: Add weather icons -->
        <!-- https://github.com/Makin-Things/weather-icons/tree/main/static -->
        {% if current.weathercode == 0 %}â˜€ï¸ <!-- Clear sky -->
        {% elif current.weathercode in [1, 2, 3] %}â›… <!-- Partly cloudy-->
        {% elif current.weathercode in [45, 48] %}ğŸŒ«ï¸ <!-- Fog -->
        {% elif current.weathercode in [51, 53, 55, 56, 57] %}ğŸŒ§ï¸ <!-- light rain  -->
        {% elif current.weathercode in [61, 63, 65] %}ğŸŒ§ï¸ <!-- Rain -->
        {% elif current.weathercode in [66, 67] %}ğŸŒ¨ï¸ <!-- Freezing rain -->
        {% elif current.weathercode in [71, 73, 75, 77] %}â„ï¸ <!-- Snow -->
        {% elif current.weathercode in [80, 81, 82] %}ğŸŒ¦ï¸ <!-- Rain shower -->
        {% elif current.weathercode in [85, 86] %}ğŸŒ¨ï¸ <!-- Snow shower -->
        {% elif current.weathercode in [95, 96, 99] %}â›ˆï¸ <!-- Thunderstorm -->
        {% endif %}
      </div>
      <div class="temperature">{{ current.temperature_2m }}Â°C</div>
    </div>

    <div class="hourly-chart">
      <h3>Voorspelling per uur</h3>
      <canvas id="hourlyChart"></canvas>
    </div>
  </div>

  <div class="daily-forecast">
    {% for day in daily.time %}
      <div class="forecast-card">
        <strong>{{ day }}</strong>
        <div class="weather-icon">
          {% if daily.weathercode[loop.index0] == 0 %}â˜€ï¸
          {% elif daily.weathercode[loop.index0] in [1, 2, 3] %}â›…
          {% elif daily.weathercode[loop.index0] in [45, 48] %}ğŸŒ«ï¸
          {% elif daily.weathercode[loop.index0] in [51, 53, 55, 56, 57] %}ğŸŒ§ï¸
          {% elif daily.weathercode[loop.index0] in [61, 63, 65] %}ğŸŒ§ï¸
          {% elif daily.weathercode[loop.index0] in [66, 67] %}ğŸŒ¨ï¸
          {% elif daily.weathercode[loop.index0] in [71, 73, 75, 77] %}â„ï¸
          {% elif daily.weathercode[loop.index0] in [80, 81, 82] %}ğŸŒ¦ï¸
          {% elif daily.weathercode[loop.index0] in [85, 86] %}ğŸŒ¨ï¸
          {% elif daily.weathercode[loop.index0] in [95, 96, 99] %}â›ˆï¸
          {% endif %}
        </div>
          <div class="temperature">
            {{ daily.temperature_2m_max[loop.index0] }}Â°C / {{ daily.temperature_2m_min[loop.index0] }}Â°C
          </div>
      </div>
    {% endfor %}
  </div>

  <script>
    const hourlyData = {{ hourly | tojson | safe }};
    const currentHourIndex = {{ current_hour_index }};
    createHourlyChart(hourlyData, currentHourIndex);

    // Check if weather data is stale and force refresh if needed
    function checkFreshness() {
      const now = new Date();
      const lastUpdated = new Date("{{ last_updated }}");
      const hoursSinceUpdate = (now - lastUpdated) / (1000 * 60 * 60);
      
      if (hoursSinceUpdate > 1.1) {
        console.log("Weather data is stale, refreshing...");
        fetch("/refresh").then(() => window.location.reload());
      }
    }
    
    // Check freshness on page load and every 5 minutes
    checkFreshness();
    setInterval(checkFreshness, 5 * 60 * 1000);
  </script>
</body>
</html>